<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أداة النشر التلقائي في Blogger (نسخة مطورة)</title>
    <!-- Tailwind CSS CDN for utility-first styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Cairo for a clean, modern Arabic font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Google API Client Library for Blogger API interaction -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <!-- Google Identity Services for OAuth 2.0 authentication -->
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <!-- Feather Icons for lightweight, beautiful SVG icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* Base font family for the entire body */
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f2f5; /* Light background for the page */
        }
        /* Common button styles */
        .btn {
            @apply inline-flex items-center justify-center px-5 py-2.5 rounded-lg font-semibold text-white shadow-md transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        /* Primary button style (blue gradient) */
        .btn-primary {
            @apply bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 focus:ring-blue-500;
        }
        /* Secondary button style (gray) */
        .btn-secondary {
            @apply bg-gray-500 hover:bg-gray-600 focus:ring-gray-400;
        }
        /* Success button style (green gradient) */
        .btn-success {
            @apply bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 focus:ring-green-500;
        }
        /* Danger button style (red gradient) */
        .btn-danger {
            @apply bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 focus:ring-red-500;
        }
        /* Warning button style (yellow gradient) */
        .btn-warning {
             @apply bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 focus:ring-yellow-500;
        }
        /* Card style for sections */
        .card {
            @apply bg-white rounded-xl shadow-lg p-6 sm:p-8 my-5 transition-all duration-300;
        }
        /* Input field common styles */
        .input-field {
            @apply w-full p-3 border border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow;
        }
        /* Label text styles */
        .label-text {
             @apply block font-semibold mb-2 text-slate-700;
        }
        /* Keyframe animation for spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Spinner styles */
        .spinner {
             @apply w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Main Container: Centers content and sets max width -->
    <div id="main-container" class="container mx-auto max-w-5xl p-4">

        <!-- Header Section -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-slate-300">
            <div class="flex items-center space-x-3 rtl:space-x-reverse">
                <!-- Pen icon for the logo -->
                <i data-feather="pen-tool" class="w-8 h-8 text-blue-600"></i>
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-slate-800">أداة النشر الاحترافية لـ Blogger</h1>
                    <p class="text-slate-500">مدعومة بـ Gemini AI</p>
                </div>
            </div>
            <!-- Authentication Status and Controls (populated by JavaScript) -->
            <div id="auth-status" class="flex items-center space-x-4 rtl:space-x-reverse">
                <!-- Content will be dynamically inserted here -->
            </div>
        </header>

        <!-- Login Section: Shown when not authenticated -->
        <div id="login-section" class="text-center card">
            <!-- Login icon -->
            <i data-feather="log-in" class="w-16 h-16 text-blue-500 mx-auto mb-4"></i>
            <h2 class="text-2xl font-bold mb-4">مرحباً بك!</h2>
            <p class="text-slate-600 mb-6 max-w-md mx-auto">الرجاء تسجيل الدخول بحساب Google الخاص بك للبدء في توليد ونشر المقالات بكل سهولة.</p>
            <!-- Google Sign-In Button -->
            <button id="authorize_button" class="btn btn-primary">
                <!-- Google icon SVG -->
                <svg class="w-5 h-5 mr-2 ml-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.244,44,30.038,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                <span>تسجيل الدخول بواسطة Google</span>
            </button>
        </div>

        <!-- Main Application Section: Hidden by default, shown after authentication -->
        <div id="app-section" class="hidden">
            
            <!-- Step 1: Generate Article Card -->
            <div class="card">
                <h2 class="text-xl font-bold mb-4 border-b pb-3 flex items-center">
                    <i data-feather="edit" class="mr-2 ml-0 text-blue-500"></i>الخطوة 1: توليد المقال
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="article-topic" class="label-text">موضوع المقال:</label>
                        <input type="text" id="article-topic" class="input-field" placeholder="مثال: مستقبل الطاقة المتجددة في الشرق الأوسط">
                    </div>
                    <div>
                         <label for="article-style" class="label-text">اختر أسلوب الكتابة:</label>
                         <select id="article-style" class="input-field bg-white">
                            <option value="professional" selected>احترافي</option>
                            <option value="friendly">ودي وبسيط</option>
                            <option value="seo">مُحسّن لمحركات البحث (SEO)</option>
                            <option value="story">سرد قصصي</option>
                         </select>
                    </div>
                </div>
                <div class="mt-6">
                    <button id="generate-btn" class="btn btn-primary">
                        <i data-feather="cpu" class="mr-2 ml-0"></i>
                        <span id="generate-btn-text">توليد المقال بواسطة Gemini</span>
                        <div id="generate-spinner" class="hidden spinner"></div>
                    </button>
                </div>
            </div>

            <!-- Step 2: Review and Publish Card: Hidden by default, shown after article generation -->
            <div id="publish-card" class="card hidden">
                <h2 class="text-xl font-bold mb-4 border-b pb-3 flex items-center">
                    <i data-feather="send" class="mr-2 ml-0 text-green-500"></i>الخطوة 2: مراجعة ونشر
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div>
                        <label for="blog-select" class="label-text">اختر المدونة للنشر فيها:</label>
                        <select id="blog-select" class="input-field bg-white"></select>
                    </div>
                    <div>
                         <label for="post-status" class="label-text">حالة المقال:</label>
                         <select id="post-status" class="input-field bg-white">
                            <option value="publish" selected>نشر فوري</option>
                            <option value="draft">حفظ كمسودة</option>
                         </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="article-title" class="label-text">عنوان المقال:</label>
                    <input type="text" id="article-title" class="input-field">
                </div>

                <div class="mb-4">
                    <label for="article-labels" class="label-text">التصنيفات (افصل بينها بفاصلة ,):</label>
                    <input type="text" id="article-labels" class="input-field" placeholder="تقنية, أخبار, تحديثات...">
                </div>
                
                <div class="mb-4">
                    <label for="article-content" class="label-text">محتوى المقال (HTML):</label>
                    <textarea id="article-content" rows="15" class="input-field"></textarea>
                </div>

                <div class="flex items-center space-x-4 rtl:space-x-reverse">
                    <button id="publish-btn" class="btn btn-success">
                        <i data-feather="check-circle" class="mr-2 ml-0"></i>
                        <span id="publish-btn-text">نشر في Blogger</span>
                        <div id="publish-spinner" class="hidden spinner"></div>
                    </button>
                    <button id="clear-btn" class="btn btn-warning">
                        <i data-feather="delete" class="mr-2 ml-0"></i>
                        <span>مسح الحقول</span>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Notification Modal: Custom modal for alerts and confirmations -->
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center transform transition-all scale-95 opacity-0" id="modal-content">
            <div id="modal-icon" class="mx-auto mb-4"></div>
            <h3 id="modal-title" class="text-lg font-bold mb-2"></h3>
            <p id="modal-message" class="text-slate-600 mb-6"></p>
            <a id="modal-link" href="#" target="_blank" class="btn btn-primary hidden">عرض المنشور</a>
            <button id="modal-close-btn" class="btn btn-secondary mt-4">إغلاق</button>
        </div>
    </div>

    <script type="text/javascript">
        // --- Configuration Variables ---
        // Gemini API Key (replace with your actual key if different)
        const API_KEY = 'AIzaSyCckxLP-wDTrFop_7EELhAGZmT7h4dw0wM'; 
        // Google Cloud Client ID for OAuth (replace with your actual client ID if different)
        const CLIENT_ID = '969437325749-71frkrdm6d4k60p36i8k4poonfil3rv8.apps.googleusercontent.com'; 
        // OAuth scopes required for Blogger API and user profile information
        const SCOPES = 'https://www.googleapis.com/auth/blogger https://www.googleapis.com/auth/userinfo.profile';

        // Global variables for Google API client and authentication status
        let tokenClient; // Google Identity Services client for token management
        let gapiInited = false; // Flag to check if GAPI client is initialized
        let gisInited = false; // Flag to check if GIS client is initialized

        // --- UI Element References ---
        const authorizeButton = document.getElementById('authorize_button');
        // Dynamically create sign-out button
        const signoutButton = document.createElement('button');
        signoutButton.className = 'btn btn-danger';
        signoutButton.innerHTML = `<i data-feather="log-out" class="w-5 h-5 sm:mr-2 sm:ml-0"></i><span class="hidden sm:inline">تسجيل الخروج</span>`;
        signoutButton.onclick = handleSignoutClick; // Assign click handler

        const loginSection = document.getElementById('login-section'); // Login screen container
        const appSection = document.getElementById('app-section');     // Main app container
        const authStatusDiv = document.getElementById('auth-status'); // Div for displaying auth status (user info, sign-out)
        const blogSelect = document.getElementById('blog-select');     // Dropdown for selecting Blogger blog
        const generateBtn = document.getElementById('generate-btn');   // Button to generate article
        const publishBtn = document.getElementById('publish-btn');     // Button to publish article
        const clearBtn = document.getElementById('clear-btn');         // Button to clear form fields
        const publishCard = document.getElementById('publish-card');   // Card containing publish controls

        // --- Form Field References ---
        const articleTopicInput = document.getElementById('article-topic');     // Input for article topic
        const articleStyleSelect = document.getElementById('article-style');   // Select for article writing style
        const articleTitleInput = document.getElementById('article-title');     // Input for article title
        const articleContentInput = document.getElementById('article-content'); // Textarea for article content (HTML)
        const articleLabelsInput = document.getElementById('article-labels');   // Input for article labels (tags)
        const postStatusSelect = document.getElementById('post-status');       // Select for post status (publish/draft)

        // --- Notification Modal Element References ---
        const modal = document.getElementById('notification-modal');       // The modal overlay
        const modalContent = document.getElementById('modal-content');     // The modal content box
        const modalIcon = document.getElementById('modal-icon');           // Div for modal icon (success, error, warning)
        const modalTitle = document.getElementById('modal-title');         // Modal title text
        const modalMessage = document.getElementById('modal-message');     // Modal message text
        const modalLink = document.getElementById('modal-link');           // Link for published post (optional)
        const modalCloseBtn = document.getElementById('modal-close-btn'); // Button to close the modal
        modalCloseBtn.onclick = hideNotification; // Assign click handler to close button
        // Close modal when clicking outside the content area
        modal.onclick = (e) => { 
            if (e.target === modal) hideNotification(); 
        };

        /**
         * Initializes Feather Icons across the page.
         * This function should be called after the DOM is loaded and whenever new icons are added.
         */
        function initIcons() {
            feather.replace(); // Replaces `data-feather` attributes with SVG icons
        }

        /**
         * Callback function for the Google API client library (gapi.js) load event.
         * Initializes the GAPI client with the Blogger API discovery document.
         */
        function gapiLoaded() {
            gapi.load('client:oauth2', initializeGapiClient);
        }

        /**
         * Callback function for the Google Identity Services library (gsi.js) load event.
         * Initializes the token client for OAuth 2.0.
         */
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, // Your Google Cloud Client ID
                scope: SCOPES,        // Required OAuth scopes
                callback: '',         // Callback will be defined dynamically before requesting token
            });
            gisInited = true; // Set GIS initialized flag
            maybeEnableButtons(); // Check if all libraries are loaded to enable UI
        }

        /**
         * Initializes the GAPI client by loading the Blogger API discovery document.
         */
        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/blogger/v3/rest'], // Blogger API discovery document
            });
            gapiInited = true; // Set GAPI initialized flag
            maybeEnableButtons(); // Check if all libraries are loaded to enable UI
        }

        /**
         * Enables UI elements (like the authorize button) once both GAPI and GIS libraries are loaded.
         */
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                authorizeButton.onclick = handleAuthClick; // Assign click handler to authorize button
                initIcons(); // Initialize icons after initial UI setup
            }
        }

        /**
         * Handles the click event for the authorization button.
         * Requests an access token from Google Identity Services.
         */
        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                // Handle any errors during token request
                if (resp.error !== undefined) {
                    console.error("Authentication error:", resp);
                    showNotification('error', 'خطأ في المصادقة', 'فشل تسجيل الدخول. الرجاء المحاولة مرة أخرى.');
                    return;
                }
                // If successful, update the UI with user information
                await updateUiWithUserInfo();
            };

            // If no token exists, request consent from the user. Otherwise, request silently.
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        /**
         * Handles the click event for the sign-out button.
         * Revokes the access token and updates the UI to the signed-out state.
         */
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token); // Revoke the access token
                gapi.client.setToken(''); // Clear the token from GAPI client
                updateUiForSignedOutState(); // Update UI
            }
        }

        /**
         * Updates the UI to reflect a signed-in user.
         * Fetches user profile information and loads their Blogger blogs.
         */
        async function updateUiWithUserInfo() {
            loginSection.classList.add('hidden');    // Hide login section
            appSection.classList.remove('hidden');   // Show main app section

            try {
                // Fetch user profile information (name, picture)
                const userInfoResponse = await gapi.client.oauth2.userinfo.get();
                const profile = userInfoResponse.result;
                
                authStatusDiv.innerHTML = ''; // Clear previous content
                const profileDiv = document.createElement('div');
                profileDiv.className = 'flex items-center space-x-2 rtl:space-x-reverse';
                profileDiv.innerHTML = `
                    <span class="font-semibold hidden sm:block">${profile.name}</span>
                    <img src="${profile.picture}" class="w-10 h-10 rounded-full border-2 border-white shadow-md" alt="${profile.name}'s profile picture">
                `;
                authStatusDiv.appendChild(profileDiv);
                authStatusDiv.appendChild(signoutButton); // Add sign-out button
                
                await loadUserBlogs(); // Load user's blogs into the dropdown
                initIcons(); // Re-initialize icons for newly added elements
            } catch (err) {
                console.error("Error updating UI with user info:", err);
                showNotification('error', 'خطأ في تحميل معلومات المستخدم', err.result?.error?.message || 'حدث خطأ أثناء جلب معلومات المستخدم.');
                updateUiForSignedOutState(); // Revert to signed-out state on error
            }
        }

        /**
         * Updates the UI to reflect a signed-out user.
         * Hides the main app and shows the login section.
         */
        function updateUiForSignedOutState() {
            appSection.classList.add('hidden');     // Hide main app
            publishCard.classList.add('hidden');    // Hide publish card
            loginSection.classList.remove('hidden'); // Show login section
            authStatusDiv.innerHTML = '';           // Clear auth status display
            clearForm(); // Clear any existing form data
        }

        /**
         * Fetches and populates the dropdown list with the authenticated user's Blogger blogs.
         */
        async function loadUserBlogs() {
            try {
                // List blogs for the authenticated user ('self')
                const response = await gapi.client.blogger.blogs.list({ userId: 'self' });
                const blogs = response.result.items;
                blogSelect.innerHTML = ''; // Clear existing options

                if (blogs && blogs.length > 0) {
                    // Populate dropdown with blog names and IDs
                    blogs.forEach(blog => {
                        const option = document.createElement('option');
                        option.value = blog.id;
                        option.textContent = blog.name;
                        blogSelect.appendChild(option);
                    });
                } else {
                    showNotification('error', 'لم يتم العثور على مدونات', 'لم نتمكن من العثور على أي مدونات مرتبطة بحسابك. الرجاء التأكد من وجود مدونات على Blogger.');
                }
            } catch (err) {
                console.error("Error fetching blogs:", err);
                showNotification('error', 'خطأ في جلب المدونات', err.result?.error?.message || 'حدث خطأ غير متوقع أثناء جلب المدونات.');
            }
        }

        /**
         * Event listener for the "Generate Article" button.
         * Calls the Gemini API to generate article content based on topic and style.
         */
        generateBtn.addEventListener('click', async () => {
            const topic = articleTopicInput.value.trim();
            const style = articleStyleSelect.value;

            if (!topic) {
                showNotification('warning', 'موضوع فارغ', 'الرجاء إدخال موضوع للمقال أولاً.');
                return;
            }

            setLoadingState(generateBtn, true); // Show loading spinner on the generate button
            
            // Define prompts based on selected writing style
            const stylePrompts = {
                professional: "اكتب مقالاً مفصلاً واحترافياً بلهجة رسمية.",
                friendly: "اكتب مقالاً بأسلوب ودي وبسيط وممتع للقارئ.",
                seo: "اكتب مقالاً مُحسّناً لمحركات البحث (SEO). استخدم كلمات مفتاحية ذات صلة بشكل طبيعي، وقسّم المحتوى بعناوين فرعية (H2, H3) واضحة، واجعل الفقرات قصيرة وسهلة القراءة.",
                story: "اكتب مقالاً على شكل قصة مشوقة تجذب القارئ."
            };

            // Construct the full prompt for the Gemini API
            const prompt = `${stylePrompts[style]}
                الموضوع هو: "${topic}".
                يجب أن يكون المقال باللغة العربية ومنسقاً بشكل جيد باستخدام HTML.
                ابدأ بعنوان جذاب داخل وسم <h1>.
                استخدم وسوم <h2> للعناوين الفرعية و <p> للفقرات.
                يمكنك استخدام <ul>, <ol>, و <li> للقوائم.
                المقال يجب أن يكون جاهزاً للنشر مباشرة. لا تضف أي نص توضيحي خارج محتوى المقال.`;

            try {
                // Make a fetch call to the Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                // Check for HTTP errors
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                // Extract content from the Gemini response
                if (result.candidates && result.candidates[0].content.parts[0].text) {
                    const fullContent = result.candidates[0].content.parts[0].text;
                    // Extract title using regex (first H1 tag)
                    const titleMatch = fullContent.match(/<h1[^>]*>([\s\S]*?)<\/h1>/i);
                    const title = titleMatch ? titleMatch[1].trim() : topic; // Use topic as fallback title
                    // Remove the H1 tag from content to avoid duplication in Blogger
                    const content = fullContent.replace(/<h1[^>]*>[\s\S]*?<\/h1>/i, '').trim();

                    articleTitleInput.value = title;       // Populate title field
                    articleContentInput.value = content;   // Populate content field
                    publishCard.classList.remove('hidden'); // Show the publish card
                } else {
                    throw new Error("لم يتمكن النموذج من توليد محتوى. حاول مرة أخرى.");
                }
            } catch (error) {
                console.error('Error generating article:', error);
                showNotification('error', 'خطأ في توليد المقال', error.message);
            } finally {
                setLoadingState(generateBtn, false); // Hide loading spinner
            }
        });

        /**
         * Event listener for the "Publish to Blogger" button.
         * Inserts the generated article as a new post in the selected Blogger blog.
         */
        publishBtn.addEventListener('click', async () => {
            const blogId = blogSelect.value;
            const title = articleTitleInput.value.trim();
            const content = articleContentInput.value.trim();
            // Split labels by comma and trim whitespace
            const labels = articleLabelsInput.value.trim() ? articleLabelsInput.value.split(',').map(label => label.trim()) : [];
            const isDraft = postStatusSelect.value === 'draft'; // Determine if it's a draft

            // Validate required fields
            if (!blogId || !title || !content) {
                showNotification('warning', 'معلومات ناقصة', 'الرجاء التأكد من اختيار مدونة وملء العنوان والمحتوى.');
                return;
            }

            setLoadingState(publishBtn, true); // Show loading spinner on the publish button

            try {
                // Call Blogger API to insert a new post
                const response = await gapi.client.blogger.posts.insert({
                    blogId: blogId, // ID of the target blog
                    isDraft: isDraft, // Set as draft or publish immediately
                    resource: {
                        title: title,   // Post title
                        content: content, // Post content (HTML)
                        labels: labels  // Post labels/tags
                    }
                });
                
                const message = isDraft ? 'تم حفظ المسودة بنجاح!' : 'تم نشر المقال بنجاح!';
                // Show success notification with a link to the published post
                showNotification('success', 'عملية ناجحة!', message, response.result.url);

            } catch (err) {
                console.error("Error publishing post:", err);
                showNotification('error', 'خطأ في النشر', err.result?.error?.message || 'حدث خطأ غير متوقع أثناء النشر.');
            } finally {
                setLoadingState(publishBtn, false); // Hide loading spinner
            }
        });
        
        /**
         * Event listener for the "Clear Fields" button.
         * Resets all article-related form fields and hides the publish card.
         */
        clearBtn.addEventListener('click', clearForm);
        function clearForm() {
            articleTitleInput.value = '';
            articleContentInput.value = '';
            articleLabelsInput.value = '';
            articleTopicInput.value = '';
            publishCard.classList.add('hidden'); // Hide the publish card
        }

        /**
         * Toggles the loading state (spinner and text visibility) for a given button.
         * @param {HTMLElement} button - The button element to modify.
         * @param {boolean} isLoading - True to show loading state, false to hide.
         */
        function setLoadingState(button, isLoading) {
            const text = button.querySelector('span');   // Text span within the button
            const spinner = button.querySelector('div'); // Spinner div within the button
            const icon = button.querySelector('i');      // Icon element within the button

            if (isLoading) {
                button.disabled = true;           // Disable button
                text.classList.add('opacity-0');  // Hide text
                spinner.classList.remove('hidden'); // Show spinner
                if(icon) icon.classList.add('opacity-0'); // Hide icon
            } else {
                button.disabled = false;          // Enable button
                text.classList.remove('opacity-0'); // Show text
                spinner.classList.add('hidden');    // Hide spinner
                if(icon) icon.classList.remove('opacity-0'); // Show icon
            }
        }

        /**
         * Displays a custom notification modal with a given type, title, message, and optional link.
         * @param {string} type - Type of notification ('success', 'error', 'warning').
         * @param {string} title - Title of the notification.
         * @param {string} message - Main message of the notification.
         * @param {string} [link=null] - Optional URL to display as a link (e.g., to the published post).
         */
        function showNotification(type, title, message, link = null) {
            modalTitle.textContent = title;   // Set modal title
            modalMessage.textContent = message; // Set modal message
            modalIcon.innerHTML = '';         // Clear previous icon
            modalLink.classList.add('hidden'); // Hide link by default

            // SVG icons for different notification types
            const icons = {
                success: `<svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                error: `<svg class="w-16 h-16 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                warning: `<svg class="w-16 h-16 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`
            };
            
            modalIcon.innerHTML = icons[type]; // Set the appropriate icon
            if (type === 'success' && link) {
                modalLink.href = link;           // Set link URL
                modalLink.classList.remove('hidden'); // Show the link button
            }
            
            modal.classList.remove('hidden'); // Show the modal overlay
            // Animate modal content in
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }
        
        /**
         * Hides the notification modal with a slight animation.
         */
        function hideNotification() {
            modalContent.classList.add('scale-95', 'opacity-0'); // Animate modal content out
            setTimeout(() => {
                 modal.classList.add('hidden'); // Hide modal overlay after animation
            }, 200);
        }

        // Initial call to render Feather Icons on page load
        initIcons();
    </script>
</body>
</html>
