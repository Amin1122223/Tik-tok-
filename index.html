<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أداة النشر التلقائي في بلوجر مع Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-primary {
            @apply w-full text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center;
            background: linear-gradient(to right, #3b82f6, #6366f1);
            box-shadow: 0 4px 15px 0 rgba(59, 130, 246, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(59, 130, 246, 0.5);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="main-container" class="min-h-screen flex flex-col items-center justify-center p-4">

        <!-- Login Section -->
        <div id="login-section" class="w-full max-w-md text-center">
            <div class="glass-card p-8 rounded-2xl shadow-lg">
                <h1 class="text-3xl font-bold mb-2">أداة النشر الذكي</h1>
                <p class="text-gray-300 mb-6">أنشئ وانشر مقالاتك في Blogger بلمسة زر</p>
                <div id="g_id_onload"
                     data-client_id="969437325749-71frkrdm6d4k60p36i8k4poonfil3rv8.apps.googleusercontent.com"
                     data-callback="handleSignIn"
                     data-auto_prompt="false">
                </div>
                <div class="g_id_signin"
                     data-type="standard"
                     data-shape="rectangular"
                     data-theme="outline"
                     data-text="signin_with"
                     data-size="large"
                     data-logo_alignment="left">
                </div>
                <p class="text-xs text-gray-500 mt-4">ملاحظة: تسجيل الدخول مطلوب للوصول إلى حسابك في Blogger.</p>
            </div>
        </div>

        <!-- App Section -->
        <div id="app-section" class="hidden w-full max-w-4xl">
            <div class="flex justify-between items-center mb-6">
                <div id="user-info" class="flex items-center gap-3">
                    <!-- User info will be populated by JS -->
                </div>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">تسجيل الخروج</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Generation Card -->
                <div class="glass-card p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                        1. إنشاء المقال
                    </h2>
                    <div class="space-y-4">
                        <label for="prompt" class="block font-semibold text-gray-300">اكتب فكرة المقال أو موضوعه:</label>
                        <textarea id="prompt" rows="4" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="مثال: أفضل 5 وجهات سياحية في المغرب لفصل الصيف"></textarea>
                        <button id="generate-button" class="btn-primary">
                            <span id="generate-btn-text">أنشئ المقال بواسطة Gemini</span>
                            <div id="generate-loader" class="hidden loader w-6 h-6 border-2"></div>
                        </button>
                    </div>
                </div>

                <!-- Publishing Card -->
                <div class="glass-card p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12a8 8 0 0 1 8-8 8 8 0 0 1 8 8 8 8 0 0 1-8 8 8 8 0 0 1-8-8z"/><path d="M10 9.5a2.5 2.5 0 1 1 5 0 2.5 2.5 0 0 1-5 0z"/><path d="M14 15.5a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0z"/></svg>
                        2. النشر في Blogger
                    </h2>
                    <div id="blogger-auth-section" class="space-y-4">
                        <p class="text-gray-400">يجب السماح للتطبيق بالوصول إلى حسابك في Blogger.</p>
                        <button id="authorize-blogger-button" class="btn-primary bg-orange-500" style="background: linear-gradient(to right, #f97316, #ea580c);">السماح بالوصول إلى Blogger</button>
                    </div>
                    <div id="blogger-publish-section" class="hidden space-y-4">
                         <label for="blog-select" class="block font-semibold text-gray-300">اختر مدونتك:</label>
                         <select id="blog-select" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option>الرجاء الانتظار، جاري تحميل المدونات...</option>
                         </select>
                         <button id="publish-button" class="btn-primary">
                            <span id="publish-btn-text">نشر المقال الآن</span>
                            <div id="publish-loader" class="hidden loader w-6 h-6 border-2"></div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Editor Card -->
            <div class="glass-card p-6 rounded-2xl mt-6">
                <h2 class="text-2xl font-bold mb-4">3. تحرير المحتوى</h2>
                <div class="space-y-4">
                    <label for="article-title" class="block font-semibold text-gray-300">عنوان المقال:</label>
                    <input type="text" id="article-title" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="سيتم إنشاء العنوان هنا...">
                    
                    <label for="article-content" class="block font-semibold text-gray-300">محتوى المقال:</label>
                    <textarea id="article-content" rows="15" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="سيتم إنشاء محتوى المقال هنا... يمكنك تعديله قبل النشر."></textarea>
                </div>
            </div>
            
            <!-- Message Area -->
            <div id="message-box" class="hidden mt-4 p-4 rounded-lg text-center font-semibold"></div>

        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const loginSection = document.getElementById('login-section');
        const appSection = document.getElementById('app-section');
        const userInfo = document.getElementById('user-info');
        const logoutButton = document.getElementById('logout-button');
        const promptInput = document.getElementById('prompt');
        const generateButton = document.getElementById('generate-button');
        const generateBtnText = document.getElementById('generate-btn-text');
        const generateLoader = document.getElementById('generate-loader');
        const articleTitleInput = document.getElementById('article-title');
        const articleContentInput = document.getElementById('article-content');
        const bloggerAuthSection = document.getElementById('blogger-auth-section');
        const authorizeBloggerButton = document.getElementById('authorize-blogger-button');
        const bloggerPublishSection = document.getElementById('blogger-publish-section');
        const blogSelect = document.getElementById('blog-select');
        const publishButton = document.getElementById('publish-button');
        const publishBtnText = document.getElementById('publish-btn-text');
        const publishLoader = document.getElementById('publish-loader');
        const messageBox = document.getElementById('message-box');

        // --- State ---
        let tokenClient;
        let userProfile = null;
        // Client ID for Google Sign-In (used in HTML)
        const GOOGLE_SIGN_IN_CLIENT_ID = '969437325749-71frkrdm6d4k60p36i8k4poonfil3rv8.apps.googleusercontent.com';
        // Client ID specifically for Blogger API access
        const GOOGLE_BLOGGER_CLIENT_ID = '329662306799-jphpgpts06t60pheok0arb8iss0g2pvv.apps.googleusercontent.com';
        const BLOGGER_SCOPE = 'https://www.googleapis.com/auth/blogger';

        // --- Utility Functions ---
        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = `mt-4 p-4 rounded-lg text-center font-semibold ${isError ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        function decodeJwtResponse(token) {
            let base64Url = token.split('.')[1];
            let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            let jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // --- Google Sign-In ---
        function handleSignIn(response) {
            userProfile = decodeJwtResponse(response.credential);
            loginSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            userInfo.innerHTML = `
                <img src="${userProfile.picture}" alt="Profile Picture" class="w-12 h-12 rounded-full border-2 border-blue-400">
                <div>
                    <p class="font-bold">${userProfile.name}</p>
                    <p class="text-sm text-gray-400">${userProfile.email}</p>
                </div>
            `;
            // Initialize Google API client for Blogger
            gapi.load('client', initializeGapiClient);
        }

        logoutButton.addEventListener('click', () => {
            userProfile = null;
            google.accounts.id.disableAutoSelect();
            google.accounts.id.revoke(userProfile.email, done => {
                console.log('consent revoked');
            });
            appSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
            // Reset UI
            bloggerAuthSection.classList.remove('hidden');
            bloggerPublishSection.classList.add('hidden');
            articleTitleInput.value = '';
            articleContentInput.value = '';
            promptInput.value = '';
        });

        // --- Gemini API ---
        generateButton.addEventListener('click', async () => {
            const prompt = promptInput.value.trim();
            if (!prompt) {
                showMessage('الرجاء إدخال فكرة المقال أولاً.', true);
                return;
            }

            generateBtnText.classList.add('hidden');
            generateLoader.classList.remove('hidden');
            generateButton.disabled = true;

            try {
                const fullPrompt = `اكتب مقالاً مفصلاً باللغة العربية حول الموضوع التالي: "${prompt}". 
                يجب أن يحتوي المقال على عنوان جذاب ومقدمة وفقرات منظمة وخاتمة. 
                اجعل العنوان في السطر الأول مسبوقًا بكلمة "العنوان:".
                المقال يجب أن يكون بصيغة HTML بسيطة (استخدم <p> للفقرات و <h2> للعناوين الفرعية إذا لزم الأمر).`;
                
                const apiKey = ""; // The platform will inject the key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ role: "user", parts: [{ text: fullPrompt }] }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    const titleMatch = text.match(/العنوان:(.*)/);
                    let title = "مقال بدون عنوان";
                    let content = text;

                    if (titleMatch && titleMatch[1]) {
                        title = titleMatch[1].trim();
                        content = text.replace(/العنوان:.*\n/, '').trim();
                    }
                    
                    articleTitleInput.value = title;
                    articleContentInput.value = content;
                    showMessage('تم إنشاء المقال بنجاح!', false);
                } else {
                    throw new Error('لم يتمكن Gemini من إنشاء محتوى. حاول مرة أخرى.');
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                showMessage(`حدث خطأ أثناء إنشاء المقال: ${error.message}`, true);
            } finally {
                generateBtnText.classList.remove('hidden');
                generateLoader.classList.add('hidden');
                generateButton.disabled = false;
            }
        });

        // --- Blogger API ---
        async function initializeGapiClient() {
            // Initialize the gapi client
            await gapi.client.init({
                // No client ID needed here for initialization, token will be provided with each request
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/blogger/v3/rest'],
            });
            // Initialize the token client with the Blogger-specific Client ID
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_BLOGGER_CLIENT_ID,
                scope: BLOGGER_SCOPE,
                callback: '', // defined later
            });
        }

        authorizeBloggerButton.addEventListener('click', () => {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                showMessage('تم السماح بالوصول بنجاح!', false);
                bloggerAuthSection.classList.add('hidden');
                bloggerPublishSection.classList.remove('hidden');
                await listBlogs();
            };
            // Ask for consent for the Blogger scope
            tokenClient.requestAccessToken({ prompt: 'consent' });
        });

        async function listBlogs() {
            try {
                const response = await gapi.client.blogger.blogs.listByUser({ 'userId': 'self' });
                const blogs = response.result.items;
                blogSelect.innerHTML = '';
                if (blogs && blogs.length > 0) {
                    blogs.forEach(blog => {
                        const option = document.createElement('option');
                        option.value = blog.id;
                        option.textContent = blog.name;
                        blogSelect.appendChild(option);
                    });
                } else {
                    blogSelect.innerHTML = '<option>لم يتم العثور على مدونات.</option>';
                }
            } catch (err) {
                console.error("Error listing blogs: ", err);
                showMessage('فشل في تحميل قائمة المدونات.', true);
            }
        }

        publishButton.addEventListener('click', async () => {
            const blogId = blogSelect.value;
            const title = articleTitleInput.value.trim();
            const content = articleContentInput.value.trim();

            if (!blogId || !title || !content) {
                showMessage('الرجاء التأكد من اختيار مدونة وملء العنوان والمحتوى.', true);
                return;
            }

            publishBtnText.classList.add('hidden');
            publishLoader.classList.remove('hidden');
            publishButton.disabled = true;

            try {
                const response = await gapi.client.blogger.posts.insert({
                    'blogId': blogId,
                    'resource': {
                        'title': title,
                        'content': content
                    }
                });
                console.log('Post published:', response.result);
                showMessage(`تم نشر المقال بنجاح في مدونتك!`, false);
                articleTitleInput.value = '';
                articleContentInput.value = '';
                promptInput.value = '';

            } catch (err) {
                console.error("Error publishing post: ", err);
                showMessage(`فشل نشر المقال: ${err.result.error.message}`, true);
            } finally {
                publishBtnText.classList.remove('hidden');
                publishLoader.classList.add('hidden');
                publishButton.disabled = false;
            }
        });

    </script>
</body>
</html>
