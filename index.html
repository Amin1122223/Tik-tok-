<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة التواصل الاجتماعي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #15202B;
            color: #F7F9F9;
        }
        .sidebar-link {
            @apply flex items-center gap-4 p-3 rounded-full hover:bg-gray-800 transition-colors cursor-pointer;
        }
        .post-card {
            @apply bg-gray-900 border border-gray-700 rounded-xl p-4;
        }
        .btn-primary {
            @apply bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-colors disabled:bg-blue-300 disabled:cursor-not-allowed;
        }
        .loader {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="w-full h-screen overflow-hidden">

    <!-- Login Section -->
    <div id="login-section" class="flex items-center justify-center h-full">
        <div class="text-center p-8 bg-gray-900 rounded-2xl shadow-lg max-w-sm mx-auto">
            <h1 class="text-3xl font-bold mb-2">منصة التواصل الاجتماعي</h1>
            <p class="text-gray-400 mb-6">شارك أفكارك مع العالم</p>
            <div id="g_id_onload"
                 data-client_id="969437325749-71frkrdm6d4k60p36i8k4poonfil3rv8.apps.googleusercontent.com"
                 data-callback="handleSignIn"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin"
                 data-type="standard"
                 data-shape="rectangular"
                 data-theme="outline"
                 data-text="signin_with"
                 data-size="large"
                 data-logo_alignment="left">
            </div>
        </div>
    </div>

    <!-- App Section -->
    <div id="app-section" class="hidden h-full max-w-7xl mx-auto">
        <div class="grid grid-cols-12 h-full">
            
            <!-- Sidebar -->
            <aside class="col-span-3 border-l border-gray-700 p-4 flex flex-col h-full">
                <div id="user-profile-sidebar" class="flex-grow">
                    <div class="sidebar-link text-lg font-bold" id="home-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        <span>الرئيسية</span>
                    </div>
                    <div class="sidebar-link text-lg font-bold" id="profile-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        <span>الملف الشخصي</span>
                    </div>
                </div>
                <div id="user-info-sidebar" class="flex items-center gap-3 p-3 hover:bg-gray-800 rounded-full cursor-pointer">
                    <!-- User info populated by JS -->
                </div>
                <button id="logout-button" class="w-full mt-4 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-full transition-colors">تسجيل الخروج</button>
            </aside>

            <!-- Main Content -->
            <main id="main-content" class="col-span-9 md:col-span-6 border-x border-gray-700 overflow-y-scroll no-scrollbar h-full">
                <!-- Header -->
                <div id="page-header" class="sticky top-0 bg-gray-900/80 backdrop-blur-sm z-10 p-4 border-b border-gray-700">
                    <h2 id="page-title" class="text-xl font-bold">الرئيسية</h2>
                </div>
                
                <!-- Home View -->
                <div id="home-view">
                    <!-- Create Post -->
                    <div class="p-4 border-b border-gray-700">
                        <textarea id="post-text" class="w-full bg-transparent text-lg p-2 focus:outline-none" rows="3" placeholder="ماذا يحدث؟"></textarea>
                        <div id="media-preview-container" class="my-2"></div>
                        <div class="flex justify-between items-center mt-2">
                            <div>
                                <input type="file" id="media-input" class="hidden" accept="image/*,video/*">
                                <button id="attach-media-button" class="text-blue-500 hover:bg-blue-500/10 rounded-full p-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                                </button>
                            </div>
                            <button id="submit-post-button" class="btn-primary" disabled>
                                <span id="post-btn-text">نشر</span>
                                <div id="post-loader" class="hidden loader w-5 h-5 border-2"></div>
                            </button>
                        </div>
                    </div>
                    <!-- Feed -->
                    <div id="feed-container">
                        <!-- Posts will be loaded here -->
                    </div>
                </div>

                <!-- Profile View -->
                <div id="profile-view" class="hidden">
                    <div id="profile-header" class="p-4 border-b border-gray-700">
                        <!-- Profile header populated by JS -->
                    </div>
                    <div id="user-posts-container">
                        <!-- User's posts will be loaded here -->
                    </div>
                </div>
            </main>
            
            <!-- Widgets -->
            <aside class="hidden md:block col-span-3 p-4">
                <div class="bg-gray-800 rounded-xl p-4">
                    <h3 class="font-bold text-lg mb-4">قد يهمك</h3>
                    <div class="text-gray-400 text-sm">
                        <p>مرحباً بك في منصتنا الجديدة!</p>
                        <p class="mt-2">شارك أفكارك وتواصل مع الآخرين.</p>
                    </div>
                </div>
            </aside>

        </div>
    </div>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "", // Add your Firebase config
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- DOM Elements ---
        const loginSection = document.getElementById('login-section');
        const appSection = document.getElementById('app-section');
        const userInfoSidebar = document.getElementById('user-info-sidebar');
        const logoutButton = document.getElementById('logout-button');
        const postText = document.getElementById('post-text');
        const submitPostButton = document.getElementById('submit-post-button');
        const postBtnText = document.getElementById('post-btn-text');
        const postLoader = document.getElementById('post-loader');
        const feedContainer = document.getElementById('feed-container');
        const attachMediaButton = document.getElementById('attach-media-button');
        const mediaInput = document.getElementById('media-input');
        const mediaPreviewContainer = document.getElementById('media-preview-container');
        
        const homeButton = document.getElementById('home-button');
        const profileButton = document.getElementById('profile-button');
        const homeView = document.getElementById('home-view');
        const profileView = document.getElementById('profile-view');
        const pageTitle = document.getElementById('page-title');
        const profileHeader = document.getElementById('profile-header');
        const userPostsContainer = document.getElementById('user-posts-container');


        // --- State ---
        let userProfile = null;
        let selectedFile = null;

        // --- Utility Functions ---
        function decodeJwtResponse(token) {
            let base64Url = token.split('.')[1];
            let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            let jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'الآن';
            const date = timestamp.toDate();
            const diff = Math.round((new Date() - date) / 1000);
            
            if (diff < 60) return `${diff} ث`;
            if (diff < 3600) return `${Math.floor(diff / 60)} د`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} س`;
            return date.toLocaleDateString('ar-EG');
        }
        
        function renderPost(post) {
            let mediaHTML = '';
            if (post.mediaUrl) {
                if (post.mediaType.startsWith('image/')) {
                    mediaHTML = `<img src="${post.mediaUrl}" class="mt-3 rounded-lg w-full object-cover" alt="Post media">`;
                } else if (post.mediaType.startsWith('video/')) {
                    mediaHTML = `<video src="${post.mediaUrl}" class="mt-3 rounded-lg w-full" controls></video>`;
                }
            }

            return `
                <div class="flex gap-3 p-4 border-b border-gray-700">
                    <img src="${post.authorPicture}" alt="avatar" class="w-12 h-12 rounded-full">
                    <div class="w-full">
                        <div class="flex items-center gap-2">
                            <span class="font-bold">${post.authorName}</span>
                            <span class="text-gray-500 text-sm">· ${formatTime(post.createdAt)}</span>
                        </div>
                        <p class="mt-1 whitespace-pre-wrap">${post.text}</p>
                        ${mediaHTML}
                    </div>
                </div>
            `;
        }

        // --- App Logic ---
        window.handleSignIn = function(response) {
            userProfile = decodeJwtResponse(response.credential);
            loginSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            
            userInfoSidebar.innerHTML = `
                <img src="${userProfile.picture}" alt="Profile Picture" class="w-12 h-12 rounded-full">
                <div class="flex-grow">
                    <p class="font-bold">${userProfile.name}</p>
                    <p class="text-sm text-gray-400 truncate">${userProfile.email}</p>
                </div>
            `;
            
            loadAllPosts();
        }

        logoutButton.addEventListener('click', () => {
            userProfile = null;
            google.accounts.id.disableAutoSelect();
            appSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
        });
        
        // --- Navigation ---
        function showView(viewId) {
            homeView.classList.add('hidden');
            profileView.classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
        }

        homeButton.addEventListener('click', () => {
            pageTitle.textContent = 'الرئيسية';
            showView('home-view');
            loadAllPosts();
        });

        profileButton.addEventListener('click', () => {
            pageTitle.textContent = userProfile.name;
            showView('profile-view');
            renderProfileHeader();
            loadUserPosts();
        });

        function renderProfileHeader() {
            profileHeader.innerHTML = `
                <img src="${userProfile.picture}" class="w-24 h-24 rounded-full mx-auto border-4 border-blue-500">
                <h3 class="text-2xl font-bold text-center mt-4">${userProfile.name}</h3>
                <p class="text-gray-500 text-center">${userProfile.email}</p>
            `;
        }

        // --- Post Creation ---
        postText.addEventListener('input', () => {
            submitPostButton.disabled = postText.value.trim().length === 0 && !selectedFile;
        });

        attachMediaButton.addEventListener('click', () => mediaInput.click());

        mediaInput.addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            if (selectedFile) {
                mediaPreviewContainer.innerHTML = `<p class="text-sm text-gray-400">تم اختيار: ${selectedFile.name}</p>`;
                submitPostButton.disabled = false;
            }
        });

        submitPostButton.addEventListener('click', async () => {
            if (!userProfile) return;

            postBtnText.classList.add('hidden');
            postLoader.classList.remove('hidden');
            submitPostButton.disabled = true;

            try {
                let mediaUrl = null;
                let mediaType = null;

                if (selectedFile) {
                    const storageRef = ref(storage, `posts/${userProfile.sub}/${Date.now()}_${selectedFile.name}`);
                    const snapshot = await uploadBytes(storageRef, selectedFile);
                    mediaUrl = await getDownloadURL(snapshot.ref);
                    mediaType = selectedFile.type;
                }

                await addDoc(collection(db, "posts"), {
                    text: postText.value,
                    authorId: userProfile.sub,
                    authorName: userProfile.name,
                    authorPicture: userProfile.picture,
                    createdAt: serverTimestamp(),
                    mediaUrl: mediaUrl,
                    mediaType: mediaType,
                });

                // Reset form
                postText.value = '';
                mediaInput.value = '';
                selectedFile = null;
                mediaPreviewContainer.innerHTML = '';

            } catch (error) {
                console.error("Error adding document: ", error);
                alert("حدث خطأ أثناء النشر!");
            } finally {
                postBtnText.classList.remove('hidden');
                postLoader.classList.add('hidden');
                submitPostButton.disabled = true;
            }
        });
        
        // --- Data Loading ---
        function loadAllPosts() {
            const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
            onSnapshot(q, (querySnapshot) => {
                let postsHTML = '';
                querySnapshot.forEach((doc) => {
                    postsHTML += renderPost(doc.data());
                });
                feedContainer.innerHTML = postsHTML || '<p class="text-center text-gray-500 p-8">لا توجد منشورات بعد. كن أول من ينشر!</p>';
            });
        }
        
        function loadUserPosts() {
            if (!userProfile) return;
            const q = query(collection(db, "posts"), where("authorId", "==", userProfile.sub), orderBy("createdAt", "desc"));
            onSnapshot(q, (querySnapshot) => {
                let postsHTML = '';
                querySnapshot.forEach((doc) => {
                    postsHTML += renderPost(doc.data());
                });
                userPostsContainer.innerHTML = postsHTML || '<p class="text-center text-gray-500 p-8">لم تقم بنشر أي شيء بعد.</p>';
            });
        }

    </script>
</body>
</html>
